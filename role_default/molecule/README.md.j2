# Ansible Molecule: Testing this role

This directory provides resources for testing the role and its resources with [Molecule](https://docs.ansible.com/projects/molecule/).



## Table of contents

- [Requirements](#requirements)
  - [Scenario `default`](#requirements-scenario-default)
  - [Scenario `ee`](#requirements-scenario-ee)
- [Usage](#usage)
  - [Run tests](#usage-testing)
    - [Scenario `default`](#usage-testing-default)
    - [Scenario `ee`](#usage-testing-ee)
  - [Access instance terminal](#usage-instance-access)
  - [Write tests](#usage-add-tests)
- [FAQ, troubleshooting](#faq)
  - [Molecule role path detection issues](#faq-role-path-detection)
  - [Air-gapped environments](#faq-air-gapped)
  - [Container: `inotify_init1(): Too many open files`](#faq-inotify)



## Requirements<a id="requirements"></a>

See the official documentation on how to [install Molecule](https://docs.ansible.com/projects/molecule/installation/#pip).



### Scenario `default`<a id="requirements-scenario-default"></a>

Additional requirements:

1. [Podman](https://podman.io/docs/installation).
2. The Molecule [plugin](https://github.com/ansible-community/molecule-plugins) `podman`:
   ```bash
   pip install "molecule" "molecule[podman]"
   ```
   or when using [`uv`](https://docs.astral.sh/uv/getting-started/installation/):
   ```bash
   uv pip install "molecule" "molecule-plugins[podman]"
   ```



### Scenario `ee`<a id="requirements-scenario-ee"></a>

Additional requirements:

1. [Podman](https://podman.io/docs/installation).
2. The Molecule [plugin](https://github.com/ansible-community/molecule-plugins) `podman`:
   ```bash
   pip install "molecule" "molecule[podman]"
   ```
   or when using `uv`:
   ```bash
   uv pip install "molecule" "molecule-plugins[podman]"
   ```
3. [`ansible-builder`](https://docs.ansible.com/projects/builder/en/latest/):
   ```bash
   pip install "ansible-builder"
   ```
   or when using [`uv`](https://docs.astral.sh/uv/getting-started/installation/):
   ```bash
   uv pip install "ansible-builder"
   ```



## Usage<a id="usage"></a>

### Run tests<a id="usage-testing"></a>

#### Scenario `default`<a id="usage-testing-default"></a>

Tests the role against multiple OS platforms using Podman containers.

```bash
cd "/role-root-dir"
export MOLECULE_GLOB="./{extensions/molecule,molecule}/*/molecule.yml"

# Test all defined platforms
# See the platforms key in molecule/<scenario>/molecule.yml for a list.
molecule test

# Test a single platform, use higher Ansible verbosity
molecule -vvvv test --platform-name="molecule-debian12"

# Keep instances after testing, clean up manually when done.
molecule test --destroy="never"
molecule test --platform-name="molecule-debian12" --destroy="never"
molecule list
molecule destroy
```



#### Scenario `ee`<a id="usage-testing-ee"></a>

Tests that the role can be included in an [Ansible Execution Environment (EE)](https://docs.ansible.com/projects/ansible/latest/getting_started_ee/i) built with [`ansible-builder`](https://docs.ansible.com/projects/builder/en/latest/).

```bash
cd "/role-root-dir"
export MOLECULE_GLOB="./{extensions/molecule,molecule}/*/molecule.yml"

# Test: create role artifact and EE image, verify inclusion in the EE
molecule test --scenario "ee"
```



### Access instance terminal<a id="usage-instance-access"></a>

```bash
cd "/role-root-dir"
export MOLECULE_GLOB="./{extensions/molecule,molecule}/*/molecule.yml"

molecule list
molecule login --host <name>
```



### Write tests<a id="usage-add-tests"></a>

Good starting point to add tests specific to your role:

1. **Converge** - Place `*.yml`  task files in `molecule/<scenario>/tasks/converge`.
   - Your primarily role includes should happen here to demonstrate all over functionality.
   - This step also provides verification through Ansible's declarative approach and their failures on execution.
2. **Verification** - Place `*.yml` task files in `molecule/<scenario>/tasks/verify`.
   - Usually contains `ansible.builtin.assert` tasks for validating outcomes.
   - Focuses on verifying the expected post-converge system state and runtime behavior.

This file structure allows you to update your role's `molecule` directory with the latest content from a [rendered `role_default` skeleton](https://github.com/foundata/ansible-skeletons) without losing your role-specific tests.



## FAQ<a id="faq"></a>

### Molecule role path detection issues, `MOLECULE_GLOB`<a id="faq-role-path-detection"></a>

If Molecule fails to

- detect the roles and/or
- install the updated role version on each run

try to adapt the `MOLECULE_GLOB` environment variable (which defaults to `molecule/*/molecule.yml`) and execute `molecule` from the role's root directory instead of the `extensions` subdirectory:

```bash
cd "/role-root-dir"
export MOLECULE_GLOB="./{extensions/molecule,molecule}/*/molecule.yml"
molecule list

# or inline for the following command only
MOLECULE_GLOB="./{extensions/molecule,molecule}/*/molecule.yml" molecule list
```

Further reading:

- Source: [`molecule/command/base.py`](https://github.com/ansible/molecule/blob/main/src/molecule/command/base.py)
- Issues: [4015](https://github.com/ansible/molecule/issues/4015), [4017](https://github.com/ansible/molecule/issues/4017), [4040](https://github.com/ansible/molecule/issues/4040), [4061](https://github.com/ansible/molecule/issues/4061)
- Pull requests: [4177](https://github.com/ansible/molecule/pull/4177)



### Air-gapped environments<a id="faq-air-gapped"></a>

Molecule scenarios typically require network access to Container registries ([quay.io](https://quay.io/), [docker.io / Docker Hub](https://hub.docker.com/)) and standard operating system package repositories. If your environment is air-gapped but your local network provides needed resources for a scenario, you can

1. Adapt `molecule/<scenario>/molecule.yml`, modify `platforms['image']` to use local image registries.
2. Create `molecule/<scenario>/tasks/prepare/all.yml` to extend Molecule's instance preparation phase for additional configuration using Ansible. Example:
   ```yaml
   ---

   - name: "Molecule | Prepare | Configure internal package repository mirrors for Debian/Ubuntu"
     when:
       - ansible_os_family == "Debian"
     block:
       - name: "Molecule | Prepare | Create sources.list"
         ansible.builtin.copy:
           dest: "/etc/apt/sources.list"
           content: |
             # Internal mirror for  {{ '{{' }} ansible_distribution {{ '{{' }} {{ '{{' }} ansible_distribution_release {{ '{{' }}
             deb http://internal-mirror.example.com/debian  {{ '{{' }} ansible_distribution_release {{ '{{' }} main contrib non-free
             deb http://internal-mirror.example.com/debian  {{ '{{' }} ansible_distribution_release {{ '{{' }}-updates main contrib non-free
             deb http://internal-mirror.example.com/debian-security  {{ '{{' }} ansible_distribution_release {{ '{{' }}-security main contrib non-free


       - name: "Molecule | Prepare | Update apt cache"
         ansible.builtin.apt:
           update_cache: yes
   ```
   You can also use dedicated `<inventory_hostname / platforms['name']>.yml` files to target specific instances instead of `when:` conditions in `all.yml`.



### Container: `inotify_init1(): Too many open files`<a id="faq-inotify"></a>

If you are not able to start all platform instances in parallel, you might need to increase `fs.inotify.max_user_instances` or do not run all containers at the same time (using `--platform-name` parameter):

```bash
# Inspect
sysctl fs.inotify

# Adapt (runtime only) / test with a higher value (example: 512, 524288)
echo 512 | sudo tee /proc/sys/fs/inotify/max_user_instances
echo 524288 | sudo tee /proc/sys/fs/inotify/max_user_watches

# Adapt (persistent)
echo "fs.inotify.max_user_instances=512" | sudo tee -a /etc/sysctl.conf
echo "fs.inotify.max_user_watches=524288" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

It may help during debugging to manually start a container with the same image while you hit limits and inspect its logs:

```bash
# trigger resource limit
molecule test --destroy="never"

# inspect
podman image
podman start <imageid> --log-level debug 2>&1 | grep -i -E "not|warn|err|deny|denie"
```
